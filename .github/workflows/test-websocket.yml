name: WebSocket Client Test (Remote Server)

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server Host (ç•™ç©ºåˆ™ä½¿ç”¨ Secrets)'
        required: false
        type: string
      server_port:
        description: 'Server Port (ç•™ç©ºåˆ™ä½¿ç”¨ Secrets)'
        required: false
        type: string

jobs:
  test-websocket:
    runs-on: ubuntu-latest
    timeout-minutes: 200
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install quotient directly from GitHub
        git clone https://${{ secrets.CLONE_QUOTIENT }}@github.com/trades-platform/quotient.git
        pip install ./quotient
        pip install websockets
    
    - name: Configure remote server settings
      env:
        INPUT_SERVER_HOST: ${{ github.event.inputs.server_host }}
        INPUT_SERVER_PORT: ${{ github.event.inputs.server_port }}
        SECRET_SERVER_HOST: ${{ secrets.WEBSOCKET_SERVER_HOST }}
        SECRET_SERVER_PORT: ${{ secrets.WEBSOCKET_SERVER_PORT }}
      run: |
        # ä¼˜å…ˆçº§: Secrets > æ‰‹åŠ¨è¾“å…¥ > é»˜è®¤å€¼
        if [ -n "$SECRET_SERVER_HOST" ]; then
          SERVER_HOST="$SECRET_SERVER_HOST"
          echo "âœ… ä½¿ç”¨ Secret: WEBSOCKET_SERVER_HOST"
        elif [ -n "$INPUT_SERVER_HOST" ]; then
          SERVER_HOST="$INPUT_SERVER_HOST"
          echo "âœ… ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ Host"
        else
          SERVER_HOST="localhost"
          echo "âš ï¸  ä½¿ç”¨é»˜è®¤ Host: localhost"
        fi
        
        if [ -n "$SECRET_SERVER_PORT" ]; then
          SERVER_PORT="$SECRET_SERVER_PORT"
          echo "âœ… ä½¿ç”¨ Secret: WEBSOCKET_SERVER_PORT"
        elif [ -n "$INPUT_SERVER_PORT" ]; then
          SERVER_PORT="$INPUT_SERVER_PORT"
          echo "âœ… ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ Port"
        else
          SERVER_PORT="8765"
          echo "âš ï¸  ä½¿ç”¨é»˜è®¤ Port: 8765"
        fi
        
        echo "SERVER_HOST=$SERVER_HOST" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV
        
        echo ""
        echo "ğŸ“‹ é…ç½®: $SERVER_HOST:$SERVER_PORT"
    
    - name: Test server connectivity
      run: |
        echo "ğŸ” æµ‹è¯•æœåŠ¡å™¨è¿æ¥: $SERVER_HOST:$SERVER_PORT"
        python << 'PYEOF'
        import socket
        import sys
        import os
        
        host = os.environ.get('SERVER_HOST', 'localhost')
        port = int(os.environ.get('SERVER_PORT', '8765'))
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            result = sock.connect_ex((host, port))
            sock.close()
            
            if result == 0:
                print('âœ… æœåŠ¡å™¨å¯è®¿é—®')
            else:
                print('âš ï¸  æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨')
        except Exception as e:
            print(f'âš ï¸  è¿æ¥æµ‹è¯•å¤±è´¥: {e}')
        PYEOF
    
    - name: Start client
      run: |
        echo "ğŸš€ å¯åŠ¨å®¢æˆ·ç«¯ (è¿è¡Œ 3 å°æ—¶)..."
        echo "   è¿æ¥åˆ°: ws://$SERVER_HOST:$SERVER_PORT"
        python client.py $SERVER_HOST $SERVER_PORT &
        CLIENT_PID=$!
        echo "CLIENT_PID=$CLIENT_PID" >> $GITHUB_ENV
        echo "âœ… Client PID: $CLIENT_PID"
        echo "â±ï¸  å°†è¿è¡Œ 3 å°æ—¶ (10800 ç§’)"
        sleep 5
    
    - name: Monitor client for 3 hours
      run: |
        echo "â±ï¸  ç›‘æ§ 3 å°æ—¶ (æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)..."
        
        DURATION=10800
        INTERVAL=300
        ELAPSED=0
        CHECK_COUNT=0
        
        while [ $ELAPSED -lt $DURATION ]; do
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
          CHECK_COUNT=$((CHECK_COUNT + 1))
          
          HOURS=$((ELAPSED / 3600))
          MINUTES=$(((ELAPSED % 3600) / 60))
          
          if ps -p $CLIENT_PID > /dev/null; then
            echo "âœ… [${CHECK_COUNT}] Client è¿è¡Œä¸­ - å·²è¿è¡Œ: ${HOURS}h ${MINUTES}m"
          else
            echo "âŒ Client å·²åœæ­¢ - è¿è¡Œæ—¶é•¿: ${HOURS}h ${MINUTES}m"
            exit 1
          fi
        done
        
        echo ""
        echo "âœ… æµ‹è¯•å®Œæˆ - Client æˆåŠŸè¿è¡Œ 3 å°æ—¶"
    
    - name: Cleanup
      if: always()
      run: |
        if ps -p $CLIENT_PID > /dev/null 2>&1; then
          kill $CLIENT_PID || true
          echo "âœ… Client å·²åœæ­¢"
        fi
